<html>
<head>
    <title>Jetty WTP Plugin</title>
    <link rel="stylesheet" media="screen, print" href="wiki-style.css"/>
</head>
<body>
<div id="mainContent" class="col-md-20">
                                 <div class="tab-content background-white">
              <div class="tab-pane active" id="tab-pane-main-page-content">

                
                <h1 class="firstHeading page-header" id="firstHeading">
                  <span dir="auto">Jetty/Howto/Prevent Memory Leaks</span>
                </h1>
                <div id="main-page-content">

                  <div class="alert alert-small alert-warning" id="contentSub"><span class="subpages">&lt; <a title="Jetty" href="../../Jetty.html">Jetty</a>‎ | <a href="../Howto.html" title="Jetty/Howto">Howto</a></span></div>

                  
                  
                  <div dir="ltr" class="mw-content-ltr" id="mw-content-text" lang="en"><p><br/>
</p><p><br/>
</p>
<div id="toc" class="toc"><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="Prevent Memory Leaks.html#Introduction"><span class="tocnumber">1</span> <span class="toctext">Introduction</span></a></li>
<li class="toclevel-1"><a href="Prevent Memory Leaks.html#Steps"><span class="tocnumber">2</span> <span class="toctext">Steps</span></a></li>
<li class="toclevel-1"><a href="Prevent Memory Leaks.html#Preventing_WebApp_Classloader_Pinning"><span class="tocnumber">3</span> <span class="toctext">Preventing WebApp Classloader Pinning</span></a>
<ul>
<li class="toclevel-2"><a href="Prevent Memory Leaks.html#Preventers"><span class="tocnumber">3.1</span> <span class="toctext">Preventers</span></a></li>
<li class="toclevel-2"><a href="Prevent Memory Leaks.html#How_to_Configure"><span class="tocnumber">3.2</span> <span class="toctext">How to Configure</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="Prevent Memory Leaks.html#JSP_bugs"><span class="tocnumber">4</span> <span class="toctext">JSP bugs</span></a>
<ul>
<li class="toclevel-2"><a href="Prevent Memory Leaks.html#Permgen_problems"><span class="tocnumber">4.1</span> <span class="toctext">Permgen problems</span></a></li>
</ul>
</li>
<li class="toclevel-1"><a href="Prevent Memory Leaks.html#JVM_bugs"><span class="tocnumber">5</span> <span class="toctext">JVM bugs</span></a>
<ul>
<li class="toclevel-2"><a href="Prevent Memory Leaks.html#Garbage_Collection_Problems"><span class="tocnumber">5.1</span> <span class="toctext">Garbage Collection Problems</span></a></li>
<li class="toclevel-2"><a href="Prevent Memory Leaks.html#Direct_ByteBuffers"><span class="tocnumber">5.2</span> <span class="toctext">Direct ByteBuffers</span></a></li>
</ul>
</li>
</ul>
</div>

<h2><span class="mw-headline" id="Introduction">Introduction</span></h2>
<div style="background-color: #f9f6b7; border: 1px solid #c4c295; color: black; padding: 5px; margin: 1ex 0; min-height: 35px; padding-left: 45px; font-size: 150%; color: white; background-color: #FF8888; padding: 50px" class="messagebox">
<div style="float: left; margin-left: -40px;"><a href="https://wiki.eclipse.org/File:Warning2.png" class="image"><img alt="Warning2.png" width="35" src="../../images/3/37/Warning2.png" height="35"/></a></div>
<div>Jetty 7 and Jetty 8 are now EOL (End of Life)<br/>
<p><br/>
<br/>
<br/>
THIS IS NOT THE DOCUMENTATION YOU ARE LOOKING FOR!!!!!<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
All development and stable releases are being performed with Jetty 9 and Jetty 10.<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
This <b>wiki is now officially out of date</b> and all content has been moved to the <a rel="nofollow" href="http://www.eclipse.org/jetty/documentation" class="external text">Jetty Documentation Hub</a><br/> 
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>
</p>

</div>
<p><br/>
Well, the most obvious cause of this is memory leaks in your application :) But, if you've thoroughly investigated using tools like jconsole, yourkit, jprofiler, jvisualvm or any of the other profiling and analysis tools out there and you can eliminate your code as the source of the problem, read on.
</p><p><br/>
</p>
<h2><span id="Steps" class="mw-headline">Steps</span></h2>
<h2><span class="mw-headline" id="Preventing_WebApp_Classloader_Pinning">Preventing WebApp Classloader Pinning</span></h2>
<div class="messagebox" style="background-color: #def3fe; border: 1px solid #c5d7e0; color: black; padding: 5px; margin: 1ex 0; min-height: 35px; padding-left: 45px;">
<div style="float: left; margin-left: -40px;"><a class="image" href="https://wiki.eclipse.org/File:Idea.png"><img src="../../images/a/a4/Idea.png" height="35" alt="Idea.png" width="35"/></a></div>
<div><b>Info:</b><br/>This feature is available as of jetty-7.6.6</div>
</div>
<p>There's a class of memory leak problems that are caused by code keeping references to a webapp classloader. This generally falls into 2 categories: static fields and daemon threads. For the former, a static field is initialized with the value of the classloader, which happens to be a webapp classloader; as the webapp is undeployed and redeployed, the static reference lives on, meaning that the webapp classloader cannot be garbage collected. The latter case is where a thread is started as a daemon thread and is outside the lifecycle of the webapp; threads have references to the context classloader that created them, thus leading to a memory leak if that classloader belongs to a webapp. There's a good discussion of the issue here: <a class="external autonumber" href="http://cdivilly.wordpress.com/tag/sun-awt-appcontext/" rel="nofollow">[1]</a>
</p><p>We provide a number of <a class="external text" rel="nofollow" href="http://download.eclipse.org/jetty/stable-7/xref/org/eclipse/jetty/util/preventers/package-summary.html">workaround classes</a> that pre-emptively invoke the problematic code with jetty's classloader, thereby ensuring a webapp's classloader is not pinned. Note that as some of the problematic code creates threads, you should in general be selective about which preventers you enable, and only use those that are specific to your application.
</p>
<h3><span class="mw-headline" id="Preventers">Preventers</span></h3>
<table>
<tbody><tr>
 <th>Name</th><th>Problem Addressed</th>
</tr>
<tr>
 <td valign="top">AppContextLeakPreventer</td><td>The call to AppContext.getAppContext() will keep a static reference to the context classloader. AppContext can be invoked in many different places by the jre.</td>
</tr>
<tr>
 <td valign="top">AWTLeakPreventer</td><td>The java.awt.Toolkit class has a static field that is the default toolkit. Creating the default toolkit causes the creation of an EventQueue, which has a classloader field initialized with the thread context class loader. See <a rel="nofollow" href="https://issues.jboss.org/browse/AS7-3733" class="external autonumber">[2]</a></td>
</tr>
<tr>
 <td valign="top">DOMLeakPreventer</td><td> 
DOM parsing can cause the webapp classloader to be pinned, due to the static field RuntimeException of com.sun.org.apache.xerces.internal.parsers.AbstractDOMParser. Note that the bug report at <a class="external autonumber" rel="nofollow" href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6916498">[3]</a> specifically mentions that a heap dump may not identify the GCRoot as the uncollected loader, making it difficult to identify the cause of the leak.</td>
</tr>
<tr>
 <td valign="top">DriverManagerLeakPreventer</td><td>java.sql.DriverManager keeps a static reference to the classloader, see java.sql.DriverManager.getCallerClassLoader().</td>
</tr>
<tr>
 <td valign="top">GCThreadLeakPreventer</td><td>Calls to sun.misc.GC.requestLatency create a daemon thread which keeps a reference to the context classloader. A known caller of this method is the RMI impl. See
[ <a class="external free" rel="nofollow" href="http://stackoverflow.com/questions/6626680/does-java-garbage-collection-log-entry-full-gc-system-mean-some-class-called">http://stackoverflow.com/questions/6626680/does-java-garbage-collection-log-entry-full-gc-system-mean-some-class-called</a>].</td>
</tr>
<tr>
 <td valign="top">Java2DLeakPreventer </td><td>sun.java2d.Disposer keeps a reference to the classloader. See <a class="external autonumber" rel="nofollow" href="https://issues.apache.org/bugzilla/show_bug.cgi?id=51687">[4]</a></td>
</tr>
<tr>
 <td valign="top">LDAPLeakPreventer</td><td>If com.sun.jndi.LdapPoolManager class is loaded and the system property com.sun.jndi.ldap.connect.pool.timeout is set to a nonzero value, a daemon thread is started keeps a reference to the context classloader.</td>
</tr>
<tr>
 <td valign="top">LoginConfigurationLeakPreventer</td><td>The javax.security.auth.login.Configuration class keeps a static reference to the thread context classloader.</td>
</tr>
<tr>
 <td valign="top">SecurityProviderLeakPreventer</td><td>Some security providers, such as sun.security.pkcs11.SunPKCS11 start a deamon thread which will trap the thread context classloader.</td>
</tr>
</tbody></table>
<p><br/>
</p>
<h3><span class="mw-headline" id="How_to_Configure">How to Configure</span></h3>
<p>Each preventer can be individually enabled by adding an instance to a Server with the addBean(Object) call. Here's an example of how to do it in code with the org.eclipse.jetty.util.preventers.AppContextLeakPreventer:
</p>
<div class="mw-geshi mw-code mw-content-ltr" dir="ltr"><div class="java source-java"><pre class="de1">Server server <span class="sy0">=</span> <span class="kw1">new</span> Server<span class="br0">(</span><span class="br0">)</span><span class="sy0">;</span>
server.<span class="me1">addBean</span><span class="br0">(</span><span class="kw1">new</span> AppContextLeakPreventer<span class="br0">(</span><span class="br0">)</span><span class="br0">)</span><span class="sy0">;</span></pre></div></div>
<p>The equivalent in code can be added to the $JETTY_HOME/etc/jetty.xml file or any jetty xml file that is configuring a Server instance. Note however, if you have more than one Server instance in your jvm, only configure these preventers on <i>one</i> of them. Here's the example from code put into in xml:
</p>
<div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="xml source-xml"><pre class="de1"><span class="sc3"><span class="re1">&lt;Configure</span> <span class="re0">id</span>=<span class="st0">"Server"</span> <span class="re0">class</span>=<span class="st0">"org.eclipse.jetty.server.Server"</span><span class="re2">&gt;</span></span>
 
   <span class="sc3"><span class="re1">&lt;Call</span> <span class="re0">name</span>=<span class="st0">"addBean"</span><span class="re2">&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;Arg<span class="re2">&gt;</span></span></span>
      <span class="sc3"><span class="re1">&lt;New</span> <span class="re0">class</span>=<span class="st0">"org.eclipse.jetty.util.preventers.AppContextLeakPreventer"</span><span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;/Arg<span class="re2">&gt;</span></span></span>
   <span class="sc3"><span class="re1">&lt;/Call<span class="re2">&gt;</span></span></span>
 
<span class="sc3"><span class="re1">&lt;/Configure<span class="re2">&gt;</span></span></span></pre></div></div>
<h2><span class="mw-headline" id="JSP_bugs">JSP bugs</span></h2>
<h3><span id="Permgen_problems" class="mw-headline">Permgen problems</span></h3>
<p>The JSP engine in Jetty is Jasper. This was originally developed under the Apache Tomcat project, but over time has been forked by many different projects. All jetty versions up to 6 used Apache-based Jasper exclusively, with Jetty 6 using Apache Jasper only for JSP2.0. With the advent of JSP 2.1, Jetty 6 switched to using Jasper from Sun's <a class="external text" href="https://glassfish.java.net/" rel="nofollow">Glassfish</a> project, which is now the reference implementation.
</p><p>All forks of Jasper suffer from a problem whereby the permgen space can be put under pressure by using jsp tag files. This is because of the classloading architecture of the jsp implementation. Each jsp file is effectively compiled and its class loaded in its own classloader so as to allow for hot replacement. Each jsp that contains references to a tag file will compile the tag if necessary and then load it using its own classloader. If you have many jsps that refer to the same tag file, then the tag's class will be loaded over and over again into permgen space, once for each jsp. The relevant Glassfish bug report is <a href="http://java.net/jira/browse/GLASSFISH-3963" rel="nofollow" class="external text">bug # 3963</a>, and the equivalent Apache Tomcat bug report is <a class="external text" rel="nofollow" href="https://issues.apache.org/bugzilla/show_bug.cgi?id=43878">bug # 43878</a>. The Apache Tomcat project has already closed this bug report with status WON'T FIX, however the Glassfish folks still have the bug report open and have scheduled it to be fixed. When the fix becomes available, the Jetty project will pick it up and incorporate into our release program.
</p>
<h2><span class="mw-headline" id="JVM_bugs">JVM bugs</span></h2>
<h3><span class="mw-headline" id="Garbage_Collection_Problems">Garbage Collection Problems</span></h3>
<p>One symptom of a cluster of jvm related memory issues is the OOM exception accompanied by a message such as <tt>"java.lang.OutOfMemoryError: requested xxxx bytes for xxx. Out of swap space?"</tt>.
</p><p>Sun bug number <a rel="nofollow" href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=4697804" class="external text">#4697804</a> describes how this can happen in the scenario when the garbage collector needs to allocate a bit more space during its run and tries to resize the heap but fails because the machine is out of swap space. One suggested work around is to ensure that the jvm never tries to resize the heap, by setting min heap size to max heap size:
</p>
<div class="mw-geshi mw-code mw-content-ltr" dir="ltr"><div class="text source-text"><pre class="de1">java -Xmx1024m -Xms1024m</pre></div></div>
<p>Another workaround is to ensure you have configured sufficient swap space on your device to accommodate all programs you are running concurrently.
</p>
<h3><span id="Direct_ByteBuffers" class="mw-headline">Direct ByteBuffers</span></h3>
<p>Another issue related to jvm bugs is the exhaustion of native memory. The symptoms to look out for are the process size growing, but the heap usage remaining relatively constant. Native memory can be consumed by a number of things, the JIT compiler being one, and nio ByteBuffers being another. Sun bug number <a rel="nofollow" href="http://bugs.sun.com/bugdatabase/view_bug.do?bug_id=6210541" class="external text">#6210541</a> discusses a still-unsolved problem whereby the jvm itself allocates a direct ByteBuffer in some circumstances that is never garbage collected, effectively eating native memory. <a href="http://www.jroller.com/gkorland/entry/java_s_memory_isn_t" rel="nofollow" class="external text">Guy Korland's blog</a> discusses this problem <a class="external text" href="http://www.jroller.com/gkorland/entry/java_s_memory_isn_t" rel="nofollow">here</a> and <a class="external text" rel="nofollow" href="http://www.jroller.com/gkorland/entry/java_s_memory_managment_is">here</a>. As the JIT compiler is one consumer of native memory, the lack of available memory may manifest itself in the JIT as OutOfMemory exceptions such as <tt>"Exception in thread "CompilerThread0" java.lang.OutOfMemoryError: requested xxx bytes for ChunkPool::allocate. Out of swap space?"</tt>
</p><p>By default, Jetty will allocate and manage its own pool of direct ByteBuffers for io if the nio SelectChannelConnector is configured. It also allocates MappedByteBuffers to memory-map static files via the DefaultServlet settings. However, you could be vulnerable to this jvm ByteBuffer allocation problem if you have disabled either of these options. For example, if you're on Windows, you may have disabled the use of memory-mapped buffers for the static file cache on the DefaultServlet to avoid the file-locking problem.
</p>

</div>

                    <div class="catlinks" id="catlinks"><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="https://wiki.eclipse.org/Special:Categories" title="Special:Categories">Categories</a>: <ul><li><a href="https://wiki.eclipse.org/Category:Jetty" title="Category:Jetty">Jetty</a></li><li><a title="Category:Jetty Howto" href="https://wiki.eclipse.org/Category:Jetty_Howto">Jetty Howto</a></li></ul></div></div>
                                  </div>
              </div>
            </div>
          </div>
</body>
</html>
